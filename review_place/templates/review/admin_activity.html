{% extends 'review/base.html' %}
{% load custom_filters %}

{% block content %}
<div class="container-fluid mt-4">
    <h2>User Activity Dashboard</h2>

    <form method="get" class="form-inline mb-4">
        <div class="form-group mr-2">
            <label for="time_agg">Group By</label>
            <select name="time_agg" id="time_agg" class="form-control">
                <option value="total" {% if selected_time_agg == 'total' %}selected{% endif %}>Total</option>
                <option value="yearly" {% if selected_time_agg == 'yearly' %}selected{% endif %}>Yearly</option>
                <option value="monthly" {% if selected_time_agg == 'monthly' %}selected{% endif %}>Monthly</option>
                <option value="daily" {% if selected_time_agg == 'daily' %}selected{% endif %}>Daily</option>
            </select>
        </div>
        <div class="form-group mr-2">
            <label for="activity_type">Activity Type</label>
            <select name="activity_type" id="activity_type" class="form-control">
                <option value="">All Types</option>
                {% for type_value, type_display in activity_types %}
                    <option value="{{ type_value }}" {% if selected_activity_type == type_value %}selected{% endif %}>{{ type_display }}</option>
                {% endfor %}
            </select>
        </div>
        <button type="submit" class="btn btn-primary mr-2">Filter</button>
        <a href="{% url 'admin_activity' %}" class="btn btn-secondary">Clear Filter</a>
    </form>

    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">1. User Activity Analysis</div>
                <div class="card-body">
                    <canvas id="userActivityChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">2. Content Popularity (Top 10)</div>
                <div class="card-body">
                    <canvas id="contentPopularityChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">3. Sharing Behavior</div>
                <div class="card-body">
                    <canvas id="sharingBehaviorChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">4. Time-Based Analysis</div>
                <div class="card-body">
                    <canvas id="timeBasedChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">5. Click Action Analysis</div>
                <div class="card-body">
                    <canvas id="clickActionChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <h3 class="mt-4">Activity Data Table</h3>
    <table class="table table-striped table-bordered mt-3">
        <thead class="thead-dark">
            <tr>
                <th>Period</th>
                <th>Activity Type</th>
                <th>Count</th>
            </tr>
        </thead>
        <tbody>
            {% for row in table_rows %}
            <tr>
                <td>{{ row.period }}</td>
                <td>{{ row.activity_type }}</td>
                <td>{{ row.count }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="3" class="text-center">No activity found for the selected filters.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h3 class="mt-5">Export Activity Data</h3>
    <form method="post" action="{% url 'admin_activity_export' %}" class="form-inline mb-4">
        {% csrf_token %}
        <input type="hidden" name="activity_type" value="{{ selected_activity_type|default_if_none:'' }}">
        <input type="hidden" name="time_agg" value="{{ selected_time_agg|default_if_none:'total' }}">
        <button type="submit" class="btn btn-success">Export as CSV</button>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const userActivityData = JSON.parse('{{ user_activity_data|safe }}');
        const contentPopularityData = JSON.parse('{{ content_popularity_data|safe }}');
        const sharingBehaviorData = JSON.parse('{{ sharing_behavior_data|safe }}');
        const timeBasedAnalysisData = JSON.parse('{{ time_based_analysis_data|safe }}');
        const clickActionData = JSON.parse('{{ click_action_data|safe }}');

        // 1. User Activity Chart
        const uac_ctx = document.getElementById('userActivityChart').getContext('2d', { willReadFrequently: true });
        const users = Object.keys(userActivityData);
        const activityTypes = [...new Set(Object.values(userActivityData).flatMap(Object.keys))];
        const uac_datasets = activityTypes.map(type => ({
            label: type,
            data: users.map(user => userActivityData[user][type] || 0),
            borderWidth: 1
        }));
        new Chart(uac_ctx, {
            type: 'bar',
            data: { labels: users, datasets: uac_datasets },
            options: { scales: { y: { beginAtZero: true }, x: { stacked: true } }, responsive: true }
        });

        // 2. Content Popularity Chart
        const cpc_ctx = document.getElementById('contentPopularityChart').getContext('2d', { willReadFrequently: true });
        new Chart(cpc_ctx, {
            type: 'bar',
            data: {
                labels: contentPopularityData.map(d => d.name),
                datasets: [{
                    label: 'Popularity (Views/Shares)',
                    data: contentPopularityData.map(d => d.count),
                    backgroundColor: 'rgba(75, 192, 192, 0.6)'
                }]
            },
            options: { indexAxis: 'y', responsive: true }
        });

        // 3. Sharing Behavior Chart
        const sbc_ctx = document.getElementById('sharingBehaviorChart').getContext('2d', { willReadFrequently: true });
        new Chart(sbc_ctx, {
            type: 'pie',
            data: {
                labels: Object.keys(sharingBehaviorData),
                datasets: [{ data: Object.values(sharingBehaviorData) }]
            },
            options: { responsive: true }
        });

        // 4. Time-Based Analysis Chart
        const tbc_ctx = document.getElementById('timeBasedChart').getContext('2d', { willReadFrequently: true });
        new Chart(tbc_ctx, {
            type: 'line',
            data: {
                labels: Object.keys(timeBasedAnalysisData),
                datasets: [{
                    label: 'Total Activities',
                    data: Object.values(timeBasedAnalysisData),
                    fill: false,
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1
                }]
            },
            options: { responsive: true }
        });

        // 5. Click Action Analysis Chart
        const cac_ctx = document.getElementById('clickActionChart').getContext('2d', { willReadFrequently: true });
        new Chart(cac_ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(clickActionData),
                datasets: [{ label: 'Click Count', data: Object.values(clickActionData) }]
            },
            options: { responsive: true }
        });
    });
</script>
{% endblock %}
