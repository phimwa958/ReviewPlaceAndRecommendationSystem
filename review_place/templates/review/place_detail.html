{% extends "review/base.html" %}

{% block title %}{{ place.place_name }} - Review Place{% endblock %}

{% block content %}
<div class="bg-white shadow-lg rounded-lg overflow-hidden">
<div class="min-h-screen bg-white-100 py-10 px-4">
<div class="max-w-6xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden">
    {% if place.images.all %}
        <!-- Swiper container -->
        <div class="swiper-container relative w-full h-96">
            <div class="swiper-wrapper">
                {% for image in place.images.all %}
                <div class="swiper-slide">
                    <img src="{{ image.image.url }}" alt="{{ place.place_name }}" 
                         class="w-full h-96 object-cover rounded-lg">
                </div>
                {% endfor %}
            </div>
            
            <!-- Navigation buttons -->
            <div class="swiper-button-prev"></div>
            <div class="swiper-button-next"></div>

            <!-- Pagination dots -->
            <div class="swiper-pagination"></div>
        </div>
    {% else %}
        <div class="w-full h-96 bg-gray-200 flex items-center justify-center">
            <span class="text-gray-500 text-2xl">No Image Available</span>
        </div>
    {% endif %}
        </div>

    <div class="p-8">
        <h1 class="text-4xl font-bold mb-4">{{ place.place_name }}</h1>
        <div class="flex items-center mb-4">
            <span class="text-yellow-500 text-2xl mr-2">
                {% for i in "12345" %}
                    {% if place.average_rating >= i|add:0 %}★{% else %}☆{% endif %}
                {% endfor %}
            </span>
            <span class="text-gray-700 text-xl">({{ place.average_rating|floatformat:1 }}/5.0) from {{ place.total_reviews }} review{{ place.total_reviews|pluralize }}</span>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div>
                <h3 class="text-xl font-semibold mb-2">Details</h3>
                <p class="text-gray-700 mb-1"><span class="font-semibold">Category:</span> {{ place.get_category_display }}</p>
                <p class="text-gray-700 mb-1"><span class="font-semibold">Location:</span> {{ place.location }}</p>
                <p class="text-gray-700 mb-1"><span class="font-semibold">Price Range:</span> {{ place.price_range|default:"N/A" }}</p>
                <p class="text-gray-700 mb-1"><span class="font-semibold">Open Hours:</span> {{ place.open_hours|default:"N/A" }}</p>
                <p class="text-gray-700 mb-1"><span class="font-semibold">Contact:</span> {{ place.contact_info|default:"N/A" }}</p>
                <p class="text-gray-700"><span class="font-semibold">Visits:</span> {{ place.visit_count }}</p>
            </div>
            <div>
                <h3 class="text-xl font-semibold mb-2">Description</h3>
                <p class="text-gray-700 whitespace-pre-line">{{ place.description|default:"No description available." }}</p>
            </div>
        </div>

        <div class="mb-6">
            <h3 class="text-xl font-semibold mb-2">Actions</h3>
            <div class="flex items-center space-x-4 mb-4">
                {% if user.is_authenticated %}
 <!-- เปลี่ยนไอคอนจากกดไลค์เป็นหัวใจเเละจำนวนไลค์ -->                
<form action="{% url 'like_place' place.id %}" method="post" class="m-0">
    {% csrf_token %}
    <button type="submit" class="like-button {% if user_liked_place %}liked{% endif %}">
        <!-- Empty heart -->
        <svg class="empty" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M16.5,3c-1.74,0-3.41,0.81-4.5,2.09 
                     C10.91,3.81,9.24,3,7.5,3 
                     C4.42,3,2,5.42,2,8.5 
                     c0,3.78,3.4,6.86,8.55,11.54L12,21.35 
                     l1.45-1.32C18.6,15.36,22,12.28,22,8.5 
                     C22,5.42,19.58,3,16.5,3z"/>
        </svg>
        <!-- Filled heart -->
        <svg class="filled" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 
                     2 5.42 4.42 3 7.5 3 
                     c1.74 0 3.41.81 4.5 2.09 
                     C13.09 3.81 14.76 3 16.5 3 
                     19.58 3 22 5.42 22 8.5 
                     c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
        </svg>
        {% if user_liked_place %}Unlike{% else %}Like{% endif %}
    </button>
</form>

     {% endif %}
                <p class="likes-count">{{ total_likes }} like{{ total_likes|pluralize }}</p>
            </div>
<!-- เปลี่ยนไอคอนจากกดไลค์เป็นหัวใจเเละจำนวนไลค์  -->   

            <h3 class="text-xl font-semibold mb-2">Share this Place</h3>
            <div class="flex space-x-4 mb-4">
            <button 
                class="custom-button" 
                onclick="window.open('{{ share_urls.facebook }}', '_blank'); recordShareActivity('Facebook');">
                Facebook
            </button>
            <button 
                class="custom-button-twitter"
                onclick="window.open('{{ share_urls.twitter }}', '_blank'); recordShareActivity('X (Twitter)');">
                X (Twitter)
            </button>
            <button 
                class="custom-button-linkedin"
                onclick="window.open('{{ share_urls.linkedin }}', '_blank'); recordShareActivity('LinkedIn');">
                LinkedIn
            </button>
            <button 
                class="custom-button-line"
                onclick="window.open('{{ share_urls.line }}', '_blank'); recordShareActivity('LINE');">
                LINE
            </button>
            </div>
            
            <div class="card-share">
            <div class="bg"></div>
            <div class="blob"></div>
            
            </div> <div class="flex items-center"> <input type="text" id="directShareLink" class="flex-grow border rounded-md p-2 mr-2" value="{{ place_absolute_url }}" readonly>
         
<!-- ปุ่ม Copy Link -->
            <button id="copyShareLink" class="copy-button">Copy Link</button>
            </div>
<!-- ปุ่มใหม่เเก้ไขสถานที่ -->
        {% if user.is_authenticated %}
            <div class="mb-8 flex space-x-4">
                {% if place.owner == user or user.is_staff %}
                    <a href="{% url 'edit_place' place_id=place.id %}" class="cssbuttons-io-button">
                    Edit Places
                    <div class="icon">
                    <svg
                    height="24" width="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"
                    ><path d="M0 0h24v24H0z" fill="none"></path>
                    <path
                    d="M16.172 11l-5.364-5.364 1.414-1.414L20 12l-7.778 7.778-1.414-1.414L16.172 13H4v-2z"
                    fill="currentColor"
                    ></path>
                    </svg>
                </div>
                </a>
                    <a href="{% url 'delete_place' place_id=place.id %}" class="delete-btn">
                        <button>
                            <span>Delete Places</span>
                        </button>
                    </a>
                {% endif %}
                {% if user.is_staff %}
                    <a href="{% url 'view_place_reports' place_id=place.id %}" class="report-btn">
                        <button>
                            <span>View Reports</span>
                        </button>
                    </a>
                {% elif place.owner != user %}
                    <a href="{% url 'report_place' place_id=place.id %}" class="report-btn">
                        <button>
                            <span>Report this Place</span>
                        </button>
                    </a>
                {% endif %}
            </div>
        {% else %}
        <p class="mb-6 text-gray-700">Please <a href="{% url 'login' %}?next={{ request.path }}" class="text-blue-600 hover:underline">login</a> to write a review or report this place.</p>
        {% endif %}
<!-- เเก้ไขกรอบของสถานที่เเนะนำในหน้าโพสต์สถานที่  --> 
        <hr class="my-8">
        {% if user.is_authenticated and recommended_places %}
        <div class="recommended-section mb-">
            <h2 class="recommend-title text-3xl font-bold text-transparent bg-clip-text drop-shadow-lg mt-8 animate-gradient mb-4">สถานที่เเนะนำ</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for rec_place in recommended_places %}
            <div class="bg-white shadow-md rounded-2xl overflow-hidden transform transition duration-300 hover:scale-105 hover:shadow-xl flex flex-col">
                {% if rec_place.images.all %}
                    <img src="{{ rec_place.images.first.image.url }}" 
                        alt="{{ rec_place.place_name }}" 
                        class="w-full h-56 object-cover">
                {% else %}
                    <div class="w-full h-56 bg-gray-200 flex items-center justify-center">
                        <span class="text-gray-500">No Image</span>
                    </div>
                {% endif %}

                <div class="p-5 flex flex-col flex-1">
                    <!-- Place name -->
                    <h3 class="text-xl font-bold text-gra line-clamp-1">{{ rec_place.place_name }}</h3>

                    <!-- Category -->
                    <p class="text-sm text-gray-600 mb-1">
                        <span class="font-medium text-gray-700">Category:</span> {{ rec_place.get_category_display }}
                    </p>

                    <!-- Description -->
                    <p class="text-gray-500 text-sm mb-3 line-clamp-2">
                        {{ rec_place.description|default:"No description available."|slice:":100" }}
                    </p>

                    <!-- Rating -->
                    <div class="flex items-center mb-4">
                        <span class="text-yellow-400 mr-1 text-lg">
                            {% for i in "12345" %}
                                {% if rec_place.average_rating >= i|add:0 %}★{% else %}☆{% endif %}
                            {% endfor %}
                        </span>
                        <span class="text-gray-600 text-sm">
                            ({{ rec_place.average_rating|floatformat:1 }}/5.0) • {{ rec_place.total_reviews }} review{{ rec_place.total_reviews|pluralize }}
                        </span>
                    </div>

                    <!-- ดันปุ่มลงล่าง -->
                    <div class="mt-auto">
                        <a href="{% url 'place_detail' rec_place.id %}" 
                        class="block w-full text-center bg-gradient-to-r from-blue-500 to-indigo-600 text-white py-2.5 rounded-lg font-medium hover:from-blue-600 hover:to-indigo-700 transition duration-300">
                            View Details
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        <hr class="my-8">
  </div>
            {% endif %} 
<!-- เเก้ไขกรอบของสถานที่เเนะนำในหน้าโพสต์สถานที่  --> 

        <h2 class="text-3xl font-semibold mb-6">Reviews ({{ place.total_reviews }})</h2>
        {% if user.is_authenticated %}
        <div class="mb-4">
            <a href="{% url 'add_review' place_id=place.id %}" class="login-btn">เพิ่มรีวิว</a>
        </div>
        {% endif %}
        {% for review in reviews %}
        <div class="border rounded-lg p-6 mb-4 bg-gray-50 shadow">
            <div class="flex items-start justify-between mb-2">
                <div class="flex items-center">
                    {% if review.user.profile_image %}
                        <img src="{{ review.user.profile_image.url }}" alt="Profile Image of {{ review.user.username }}" class="w-10 h-10 rounded-full object-cover mr-3">
                    {% else %}
                        <img src="/static/default.jpg" alt="Default Profile Image" class="w-16 h-10 rounded-full object-cover mr-3">
                    {% endif %}
                    <div>
                        <p class="text-lg font-semibold mb-1 ">{{ review.user.username }}</p>
                        <p class="text-sm text-gray-500">{{ review.review_date|date:"F j, Y, g:i a" }}</p>
                    </div>
                </div>
                <div class="text-yellow-500 text-xl">
                    {% for i in "12345" %}
                        {% if review.rating >= i|add:0 %}★{% else %}☆{% endif %}
                    {% endfor %}
                    <span class="text-gray-700 text-base"> ({{ review.rating }}/5)</span>
                </div>
            </div>

            {% if review.images.all %}
            <div class="grid grid-cols-1 md:grid-cols-5 gap-2 mt-4">
                {% for image in review.images.all %}
                <img src="{{ image.image.url }}" alt="Review image by {{ review.user.username }}" class="w-full h-32 object-cover">
                {% endfor %}
            </div>
            {% endif %}

            <p class="text-gray-700 mb-4 whitespace-pre-line">{{ review.review_text }}</p>

            <div class="flex items-center space-x-4">
                {% if user.is_authenticated %}
                    {% if review.user == user or user.is_staff %}
                        <a href="{% url 'edit_review' review_id=review.id %}" class="text-blue-600 hover:underline">Edit</a>
                        <a href="{% url 'delete_review' review_id=review.id %}" class="text-red-600 hover:underline">Delete</a>
                    {% endif %}
                    {% if user.is_staff %}
                        <a href="{% url 'view_review_reports' review_id=review.id %}" class="text-blue-600 hover:underline">View Reports</a>
                    {% elif review.user != user %}
                        <a href="{% url 'report_review' review_id=review.id %}" class="text-red-600 hover:underline">Report Review</a>
                    {% endif %}
                {% endif %}
                {# Placeholder for helpful count and other actions #}
                {# <span class="text-sm text-gray-500">Helpful ({{ review.helpful_count }})</span> #}
            </div>

            <!-- Comments Section -->
            <div class="mt-4 pt-4 border-t border-gray-200">
                <button class="text-sm text-blue-600 hover:underline focus:outline-none" onclick="toggleComments('comments-{{ review.id }}')">
                    Show/Hide Comments ({{ review.comments.count }})
                </button>

                <div id="comments-{{ review.id }}" class="hidden mt-4 space-y-4">
                    <!-- Existing Comments -->
                    {% for comment in review.comments.all %}
                        {% if comment.status == 'published' %}
                        <div class="flex space-x-3">
                            <div class="flex-shrink-0">
                                {% if comment.user.profile_image %}
                                    <img src="{{ comment.user.profile_image.url }}" alt="Profile Image of {{ comment.user.username }}" class="w-8 h-8 rounded-full object-cover">
                                {% else %}
                                    <img src="/static/default.jpg" alt="Default Profile Image" class="w-8 h-8 rounded-full object-cover">
                                {% endif %}
                            </div>
                            <div class="flex-1 bg-gray-100 rounded-lg p-3">
                                <div class="flex justify-between items-center">
                                    <p class="font-semibold text-sm">{{ comment.user.username }}</p>
                                    <p class="text-xs text-gray-500">{{ comment.created_at|timesince }} ago</p>
                                </div>
                                <p class="text-sm text-gray-800 mt-1">{{ comment.text }}</p>
                                <div class="text-xs mt-2 flex space-x-3">
                                    {% if user.is_authenticated %}
                                        {% if user == comment.user or user.is_staff %}
                                            <a href="{% url 'edit_comment' comment_id=comment.id %}" class="text-blue-500 hover:underline">Edit</a>
                                            <a href="{% url 'delete_comment' comment_id=comment.id %}" class="text-red-500 hover:underline">Delete</a>
                                        {% endif %}
                                        {% if user.is_staff %}
                                            <a href="{% url 'view_comment_reports' comment_id=comment.id %}" class="text-blue-500 hover:underline">View Reports</a>
                                        {% elif user != comment.user %}
                                            <a href="{% url 'report_comment' comment_id=comment.id %}" class="text-gray-500 hover:underline">Report</a>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% empty %}
                        <p class="text-sm text-gray-500">No comments yet.</p>
                    {% endfor %}

                    <!-- Add Comment Link -->
                    {% if user.is_authenticated %}
                    <div class="mt-4">
                        <a href="{% url 'add_comment' review_id=review.id %}" class="btn btn-sm btn-primary">Add Comment</a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% empty %}
        <p class="text-gray-600">No reviews yet for this place.</p>
        {% endfor %}
    </div>
</div>
<script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const shareLinks = document.querySelectorAll('.share-link');
        const copyButton = document.getElementById('copyShareLink');
        const directShareLinkInput = document.getElementById('directShareLink');
        const placeId = "{{ place.id }}";
        const csrfToken = "{{ csrf_token }}";

        function recordShareActivity(sharedTo) {
            fetch("{% url 'record_share_activity' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken
                },
                body: new URLSearchParams({
                    'shared_type': 'place',
                    'shared_id': placeId,
                    'shared_to': sharedTo
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    console.log('Share activity recorded successfully!');
                } else {
                    console.error('Error recording share activity:', data.message);
                }
            })
            .catch(error => {
                console.error('Network error recording share activity:', error);
            });
        }

        shareLinks.forEach(link => {
            link.addEventListener('click', function(event) {
                event.preventDefault();
                const sharedTo = this.dataset.sharedTo;
                const shareUrl = this.href;
                recordShareActivity(sharedTo);
                window.open(shareUrl, '_blank');
            });
        });

        if (copyButton) {
            copyButton.addEventListener('click', function() {
                directShareLinkInput.select();
                directShareLinkInput.setSelectionRange(0, 99999); // For mobile devices
                document.execCommand('copy');
                recordShareActivity('Direct Link (Copied)');
                alert('Link copied to clipboard!');
            });
        }
    });

    function toggleComments(id) {
        var element = document.getElementById(id);
        if (element.classList.contains('hidden')) {
            element.classList.remove('hidden');
        } else {
            element.classList.add('hidden');
        }
    }

document.addEventListener("DOMContentLoaded", function() {
    new Swiper(".swiper-container", {
        loop: true,              // วนซ้ำ
        slidesPerView: 1,        // รูปละ 1 เต็มหน้าจอ
        navigation: {
            nextEl: ".swiper-button-next",
            prevEl: ".swiper-button-prev",
        },
        pagination: {
            el: ".swiper-pagination",
            clickable: true,
        },
        autoplay: {
            delay: 4000,         // เลื่อนอัตโนมัติทุก 4 วิ
            disableOnInteraction: false,
        },
    });
});

</script>
{% endblock %}

